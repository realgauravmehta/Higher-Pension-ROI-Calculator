<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPS 95 Higher Pension Scheme ROI Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Enhanced slider styling */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            cursor: pointer;
            border-radius: 50%;
            margin-top: -9px;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.4);
        }
        input[type="range"]::-moz-range-thumb {
            width: 22px;
            height: 22px;
            background: linear-gradient(135deg, #2563eb, #1e40af);
            cursor: pointer;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 10px rgba(37, 99, 235, 0.4);
        }
        input[type="range"]::-webkit-slider-track {
            height: 8px;
            background: linear-gradient(90deg, #e5e7eb, #d1d5db);
            border-radius: 4px;
        }
        input[type="range"]::-moz-range-track {
            height: 8px;
            background: linear-gradient(90deg, #e5e7eb, #d1d5db);
            border-radius: 4px;
            border: none;
        }
        .gradient-border {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1px;
            border-radius: 12px;
        }
        .gradient-border > div {
            background: white;
            border-radius: 11px;
        }
        .error-shake {
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .tooltip {
            position: relative;
            cursor: help;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .tooltip-text {
            visibility: hidden;
            opacity: 0;
            background-color: #1f2937;
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -120px;
            width: 240px;
            font-size: 12px;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .collapsible-content.expanded {
            max-height: 1000px;
        }
        .scenario-comparison {
            border: 2px dashed #e5e7eb;
            transition: all 0.3s ease;
        }
        .scenario-comparison.saved {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-white to-indigo-50 text-gray-800 min-h-screen">

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <!-- Enhanced Header -->
        <header class="text-center mb-8">
            <div class="gradient-border inline-block mb-4">
                <div class="px-8 py-4">
                    <h1 class="text-3xl md:text-4xl font-bold bg-gradient-to-r from-blue-600 to-indigo-600 bg-clip-text text-transparent">
                        EPS 95 Higher Pension Scheme ROI Calculator
                    </h1>
                </div>
            </div>
            <p class="text-gray-600 mt-2 text-lg">Comprehensive analysis of enhanced pension option returns</p>
            <div id="lastUpdated" class="text-xs text-gray-400 mt-2"></div>
        </header>

        <!-- Error/Warning Banner -->
        <div id="errorBanner" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
                    </svg>
                </div>
                <div class="ml-3">
                    <p id="errorText" class="text-sm text-red-700"></p>
                </div>
                <div class="ml-auto pl-3">
                    <button onclick="hideError()" class="text-red-400 hover:text-red-600">
                        <svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Enhanced Input Panel -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                <div class="flex items-center justify-between mb-6 border-b pb-3">
                    <h2 class="text-2xl font-bold text-blue-600">Input Panel</h2>
                    <div class="flex space-x-2">
                        <button onclick="resetToDefaults()" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-md transition-colors">
                            Reset
                        </button>
                        <button onclick="saveScenario()" class="text-sm bg-blue-100 hover:bg-blue-200 text-blue-700 px-3 py-1 rounded-md transition-colors">
                            Save Scenario
                        </button>
                    </div>
                </div>
                
                <form id="pensionForm" class="space-y-6">
                    <!-- Section 1: Initial Investment -->
                    <div class="space-y-4 p-5 border-2 border-blue-100 rounded-xl bg-gradient-to-r from-blue-50/50 to-indigo-50/50">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-bold">1</div>
                            <h3 class="text-lg font-semibold text-gray-700">Initial Investment & Adjustments</h3>
                        </div>
                        <div>
                            <label for="lumpsumPaid" class="block text-sm font-medium text-gray-700 mb-1">
                                Lump-sum Paid to EPFO
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">One-time payment to EPFO to enable higher pension benefits based on actual salary</span>
                                </span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">‚Çπ</span>
                                <input type="number" id="lumpsumPaid" value="5000000" min="0" step="1000" 
                                       class="mt-1 block w-full pl-8 pr-3 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm transition-all">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">üí° Considered paid on April 1, 2025</p>
                        </div>
                        <div>
                            <label for="arrearsReceived" class="block text-sm font-medium text-gray-700 mb-1">
                                Arrears Received from EPFO
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Backdate pension arrears received from EPFO as part of the higher pension benefit</span>
                                </span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">‚Çπ</span>
                                <input type="number" id="arrearsReceived" value="1500000" min="0" step="1000"
                                       class="mt-1 block w-full pl-8 pr-3 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm transition-all">
                            </div>
                            <p class="text-xs text-gray-500 mt-1">üí° Considered received on Sep 15, 2025</p>
                        </div>
                        <div>
                            <label for="tdsOnArrears" class="block text-sm font-medium text-gray-700 mb-1">
                                TDS Deducted on Arrears
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Tax Deducted at Source on arrears payment by EPFO</span>
                                </span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">‚Çπ</span>
                                <input type="number" id="tdsOnArrears" value="150000" min="0" step="1000"
                                       class="mt-1 block w-full pl-8 pr-3 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm transition-all">
                            </div>
                            <div class="text-xs text-green-600 mt-1 font-medium">
                                Net Arrears: ‚Çπ<span id="netArrears">1350000</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Section 2: Enhanced Pension Details -->
                    <div class="space-y-4 p-5 border-2 border-green-100 rounded-xl bg-gradient-to-r from-green-50/50 to-emerald-50/50">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center text-white text-xs font-bold">2</div>
                            <h3 class="text-lg font-semibold text-gray-700">Pension Details</h3>
                        </div>
                        <div>
                            <label for="monthlyPension" class="block text-sm font-medium text-gray-700 mb-1">
                                New Monthly Pension (Pre-Tax)
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Enhanced monthly pension amount based on actual salary before tax deductions</span>
                                </span>
                            </label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">‚Çπ</span>
                                <input type="number" id="monthlyPension" value="50000" min="0" step="100"
                                       class="mt-1 block w-full pl-8 pr-3 py-3 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm transition-all">
                            </div>
                            <div class="text-xs text-green-600 mt-1 font-medium">
                                Post-Tax: ‚Çπ<span id="postTaxPension">35000</span>/month
                            </div>
                        </div>
                         <div>
                            <label for="pensionStartDate" class="block text-sm font-medium text-gray-700 mb-1">Pension Start Date</label>
                            <div class="flex space-x-2 mt-1">
                                <select id="startMonth" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 transition-all">
                                    <!-- Options generated by JS -->
                                </select>
                                <input type="number" id="startYear" value="2025" min="2020" max="2030"
                                       class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 transition-all">
                            </div>
                        </div>
                        <div>
                            <label for="taxRatePension" class="block text-sm font-medium text-gray-700 mb-2">
                                Pensioner's Tax Rate: <span class="font-bold text-blue-600"><span id="taxRatePensionValue">30.000</span>%</span>
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Include income tax, cess, and surcharge applicable to your pension income bracket</span>
                                </span>
                            </label>
                            <input type="range" id="taxRatePension" min="5" max="42.744" step="0.001" value="30" 
                                   class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span>42.744%</span>
                            </div>
                        </div>
                        <div>
                            <label for="taxRateNominee" class="block text-sm font-medium text-gray-700 mb-2">
                                Nominee's Tax Rate: <span class="font-bold text-green-600"><span id="taxRateNomineeValue">20.000</span>%</span>
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Tax rate applicable to nominee when receiving 50% pension after pensioner's demise</span>
                                </span>
                            </label>
                            <input type="range" id="taxRateNominee" min="5" max="42.744" step="0.001" value="20" 
                                   class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span>42.744%</span>
                            </div>
                        </div>
                        <div>
                            <div class="flex items-center space-x-2 mb-2">
                                <input type="checkbox" id="applySurcharge" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <label for="applySurcharge" class="text-sm font-medium text-gray-700">
                                    Apply Surcharge & Cess
                                    <span class="tooltip ml-1">
                                        <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                        </svg>
                                        <span class="tooltip-text">For higher income brackets: 10% surcharge (‚Çπ50L-‚Çπ1Cr), 15% surcharge (>‚Çπ1Cr), plus 4% health & education cess</span>
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Section 3: Personal Details -->
                    <div class="space-y-4 p-5 border-2 border-purple-100 rounded-xl bg-gradient-to-r from-purple-50/50 to-pink-50/50">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs font-bold">3</div>
                            <h3 class="text-lg font-semibold text-gray-700">Personal Details</h3>
                        </div>
                        <div>
                            <label for="pensionerDob" class="block text-sm font-medium text-gray-700 mb-1">
                                Your Date of Birth
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Used to calculate your current age and life expectancy based on Indian mortality tables (IALM 2012-14)</span>
                                </span>
                            </label>
                            <input type="date" id="pensionerDob" value="1965-04-01" max="2006-12-31"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 transition-all">
                        </div>
                        <div>
                            <label for="nomineeDob" class="block text-sm font-medium text-gray-700 mb-1">
                                Nominee's Date of Birth
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Nominee receives 50% pension after pensioner's demise. Typically spouse or dependent family member.</span>
                                </span>
                            </label>
                            <input type="date" id="nomineeDob" value="1968-04-01" max="2006-12-31"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm p-3 transition-all">
                        </div>
                    </div>

                    <!-- Section 4: Advanced Settings -->
                    <div class="space-y-4 p-5 border-2 border-orange-100 rounded-xl bg-gradient-to-r from-orange-50/50 to-yellow-50/50">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-6 h-6 bg-orange-500 rounded-full flex items-center justify-center text-white text-xs font-bold">4</div>
                            <h3 class="text-lg font-semibold text-gray-700">Economic Assumptions</h3>
                        </div>
                        <div>
                            <label for="inflationRate" class="block text-sm font-medium text-gray-700 mb-2">
                                Expected Annual Inflation Rate: <span class="font-bold text-orange-600"><span id="inflationRateValue">6.000</span>%</span>
                                <span class="tooltip ml-1">
                                    <svg class="w-4 h-4 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="tooltip-text">Used to calculate real returns (inflation-adjusted IRR). RBI targets 4% ¬± 2%, historical average is 5-7%</span>
                                </span>
                            </label>
                            <input type="range" id="inflationRate" min="3" max="10" step="0.1" value="6" 
                                   class="w-full h-3 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>3%</span>
                                <span>10%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Section 5: Informational -->
                    <div class="space-y-4 p-5 border-2 border-dashed border-yellow-200 rounded-xl bg-gradient-to-r from-yellow-50/50 to-amber-50/50">
                        <div class="flex items-center space-x-2 mb-3">
                            <div class="w-6 h-6 bg-yellow-500 rounded-full flex items-center justify-center text-white text-xs font-bold">‚Ñπ</div>
                            <h3 class="text-lg font-semibold text-yellow-800">For Information Only</h3>
                        </div>
                        <p class="text-xs text-yellow-700 mb-3 p-2 bg-yellow-100 rounded-md">
                            ‚ö†Ô∏è These fields are for your reference and are <strong>not used</strong> in the forward-looking ROI calculations.
                        </p>
                        <div>
                            <label for="pastPension" class="block text-sm font-medium text-gray-700 mb-1">Total Past Pension Received</label>
                            <div class="relative">
                                <span class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500 text-sm">‚Çπ</span>
                                <input type="number" id="pastPension" value="2000000" min="0" step="1000"
                                       class="mt-1 block w-full pl-8 pr-3 py-3 rounded-lg border-gray-300 shadow-sm focus:border-yellow-400 focus:ring-yellow-400 sm:text-sm transition-all bg-yellow-50">
                            </div>
                        </div>
                        <div>
                            <label for="pastTaxRate" class="block text-sm font-medium text-gray-700 mb-2">
                                Avg. Tax on Past Pension: <span class="font-bold text-yellow-600"><span id="pastTaxRateValue">20.000</span>%</span>
                            </label>
                            <input type="range" id="pastTaxRate" min="5" max="42.744" step="0.001" value="20" 
                                   class="w-full h-3 bg-yellow-200 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span>42.744%</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Enhanced Results Dashboard -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                <div class="flex items-center justify-between mb-6 border-b pb-3">
                    <h2 class="text-2xl font-bold text-blue-600">Results Dashboard</h2>
                    <div class="flex space-x-2">
                        <button onclick="exportResults()" class="text-sm bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors">
                            üìä Export
                        </button>
                        <button onclick="printResults()" class="text-sm bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                            üñ®Ô∏è Print
                        </button>
                    </div>
                </div>
                
                <!-- Key Assumptions Collapsible -->
                <div class="mb-6 bg-blue-50 rounded-lg border border-blue-200">
                    <button onclick="toggleAssumptions()" class="w-full px-4 py-3 text-left flex items-center justify-between text-blue-800 font-medium">
                        <span>üìã Key Assumptions & Methodology</span>
                        <svg id="assumptionsArrow" class="w-4 h-4 transform transition-transform" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                    <div id="assumptionsContent" class="collapsible-content px-4 pb-3">
                        <div class="text-sm text-blue-700 space-y-2">
                            <p>‚Ä¢ <strong>Pension Receipt:</strong> Monthly pension received at end of each month</p>
                            <p>‚Ä¢ <strong>Life Expectancy:</strong> Based on Indian Assured Lives Mortality (IALM 2012-14) tables</p>
                            <p>‚Ä¢ <strong>Nominee Pension:</strong> 50% of pensioner's amount after pensioner's demise</p>
                            <p>‚Ä¢ <strong>Tax Rates:</strong> Assumed constant throughout the investment horizon</p>
                            <p>‚Ä¢ <strong>IRR Calculation:</strong> Uses Newton-Raphson method for precise annual returns</p>
                            <p>‚Ä¢ <strong>Real Returns:</strong> Nominal IRR adjusted for expected inflation rate</p>
                            <p>‚Ä¢ <strong>Cash Flows:</strong> Considers exact timing of all inflows and outflows</p>
                        </div>
                    </div>
                </div>
                
                <!-- Enhanced Summary Section -->
                <section class="mb-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">üìä</div>
                        Summary Overview
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl text-center border border-blue-200 hover:shadow-lg transition-shadow">
                            <p class="text-sm text-blue-600 font-medium">Your Current Age</p>
                            <p id="pensionerAge" class="text-3xl font-bold text-blue-800 mt-1">-</p>
                        </div>
                        <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-4 rounded-xl text-center border border-blue-200 hover:shadow-lg transition-shadow">
                            <p class="text-sm text-blue-600 font-medium">Your Life Expectancy</p>
                            <p id="pensionerLifeExp" class="text-3xl font-bold text-blue-800 mt-1">-</p>
                        </div>
                         <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl text-center border border-green-200 hover:shadow-lg transition-shadow">
                            <p class="text-sm text-green-600 font-medium">Nominee's Current Age</p>
                            <p id="nomineeAge" class="text-3xl font-bold text-green-800 mt-1">-</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 p-4 rounded-xl text-center border border-green-200 hover:shadow-lg transition-shadow">
                            <p class="text-sm text-green-600 font-medium">Nominee's Life Expectancy</p>
                            <p id="nomineeLifeExp" class="text-3xl font-bold text-green-800 mt-1">-</p>
                        </div>
                    </div>
                    
                    <!-- Additional Key Metrics -->
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-4 rounded-xl text-center border border-purple-200">
                            <p class="text-sm text-purple-600 font-medium">Net Investment</p>
                            <p id="netInvestment" class="text-xl font-bold text-purple-800 mt-1">‚Çπ0</p>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 p-4 rounded-xl text-center border border-orange-200">
                            <p class="text-sm text-orange-600 font-medium">Monthly Post-Tax Pension</p>
                            <p id="monthlyPostTax" class="text-xl font-bold text-orange-800 mt-1">‚Çπ0</p>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 p-4 rounded-xl text-center border border-indigo-200">
                            <p class="text-sm text-indigo-600 font-medium">Annual Pension (Pre-Tax)</p>
                            <p id="annualPension" class="text-xl font-bold text-indigo-800 mt-1">‚Çπ0</p>
                        </div>
                        <div class="bg-gradient-to-br from-teal-50 to-teal-100 p-4 rounded-xl text-center border border-teal-200">
                            <p class="text-sm text-teal-600 font-medium">Simple Payback</p>
                            <p id="simplePayback" class="text-xl font-bold text-teal-800 mt-1">0 yrs</p>
                        </div>
                    </div>
                </section>

                <!-- Scenario Comparison Section -->
                <section class="mb-8" id="scenarioComparison" style="display: none;">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <div class="w-8 h-8 bg-orange-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">üîÑ</div>
                        Scenario Comparison
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div id="savedScenario" class="scenario-comparison p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-2">Saved Scenario</h4>
                            <div id="savedScenarioContent" class="text-sm text-gray-600"></div>
                        </div>
                        <div class="scenario-comparison p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-2">Current Scenario</h4>
                            <div id="currentScenarioContent" class="text-sm text-gray-600">
                                Make changes to inputs to see comparison
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Performance Indicator -->
                <div id="performanceIndicator" class="mb-6 p-4 rounded-lg border-2 hidden">
                    <div class="flex items-center">
                        <div id="performanceIcon" class="mr-3"></div>
                        <div>
                            <p id="performanceTitle" class="font-semibold"></p>
                            <p id="performanceDesc" class="text-sm"></p>
                        </div>
                    </div>
                </div>

                <!-- Enhanced IRR Analysis Section -->
                <section class="mb-8">
                    <h3 class="text-xl font-bold text-gray-700 mb-4 flex items-center">
                        <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white text-sm font-bold mr-3">üìà</div>
                        Return on Investment Analysis
                    </h3>
                    
                    <div class="overflow-x-auto shadow-lg rounded-xl border border-gray-200">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gradient-to-r from-gray-50 to-gray-100">
                                <tr>
                                    <th class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">
                                        Scenario / Time Horizon
                                    </th>
                                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">
                                        Nominal IRR (%)
                                        <span class="tooltip ml-1">
                                            <svg class="w-3 h-3 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="tooltip-text">Annual return without adjusting for inflation (post-tax)</span>
                                        </span>
                                    </th>
                                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">
                                        Real IRR (%)
                                        <span class="tooltip ml-1">
                                            <svg class="w-3 h-3 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="tooltip-text">Inflation-adjusted annual return (purchasing power)</span>
                                        </span>
                                    </th>
                                    <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">
                                        Total Pension (Post-Tax)
                                    </th>
                                    <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase tracking-wider">
                                        Payback Period
                                        <span class="tooltip ml-1">
                                            <svg class="w-3 h-3 inline text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                                            </svg>
                                            <span class="tooltip-text">Time to recover your net investment</span>
                                        </span>
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="bg-white divide-y divide-gray-200">
                                <!-- Rows will be dynamically generated by JS -->
                            </tbody>
                        </table>
                        <div id="loader" class="text-center p-12 hidden">
                            <div class="inline-flex items-center space-x-3">
                                <svg class="animate-spin h-8 w-8 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <span class="text-gray-600 font-medium">Calculating Returns...</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Visual Chart -->
                    <div class="mt-6 bg-gray-50 rounded-xl p-4">
                        <h4 class="font-semibold text-gray-700 mb-3 text-center">Post-Tax IRR Comparison</h4>
                        <div class="chart-container">
                            <canvas id="irrChart"></canvas>
                        </div>
                    </div>
                </section>

                <!-- Enhanced Insights Panel -->
                <div id="insightsPanel" class="mt-6 p-5 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-200">
                    <h4 class="font-bold text-blue-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Key Insights & Recommendations
                    </h4>
                    <div id="insights" class="space-y-2 text-sm text-blue-700">
                        <!-- Insights will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Next Steps Section -->
                <div class="mt-6 p-5 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
                    <h4 class="font-bold text-green-800 mb-3 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                        What Should You Do With These Results?
                    </h4>
                    <div class="space-y-3 text-sm text-green-700">
                        <div class="flex items-start">
                            <span class="font-bold text-green-800 mr-2">1.</span>
                            <p><strong>Compare with Safe Investments:</strong> If your post-tax IRR exceeds safe alternatives like Fixed Deposits (6-8%) or government bonds, this may be a good option.</p>
                        </div>
                        <div class="flex items-start">
                            <span class="font-bold text-green-800 mr-2">2.</span>
                            <p><strong>Consider Your Risk Profile:</strong> EPS pension is government-backed and relatively safe compared to market investments.</p>
                        </div>
                        <div class="flex items-start">
                            <span class="font-bold text-green-800 mr-2">3.</span>
                            <p><strong>Evaluate Liquidity Needs:</strong> The lump-sum payment is largely irreversible, so ensure you have adequate emergency funds.</p>
                        </div>
                        <div class="flex items-start">
                            <span class="font-bold text-green-800 mr-2">4.</span>
                            <p><strong>Consult a Financial Advisor:</strong> Discuss how this fits into your overall retirement portfolio and tax planning strategy.</p>
                        </div>
                        <div class="flex items-start">
                            <span class="font-bold text-green-800 mr-2">5.</span>
                            <p><strong>Review Periodically:</strong> Tax rates and personal circumstances change, so revisit this analysis annually.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Enhanced Footer -->
        <footer class="mt-12 text-center text-sm text-gray-500 border-t pt-6">
            <div class="max-w-4xl mx-auto">
                <p class="mb-3">üí° <strong>Important Disclaimer:</strong> This calculator provides estimates based on Indian Assured Lives Mortality (IALM 2012-14) actuarial data and your inputs. 
                Actual returns may vary based on policy changes, economic conditions, and individual circumstances.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                    <div>
                        <p class="font-semibold mb-1">üìû Official Information:</p>
                        <p>EPFO: <a href="https://www.epfindia.gov.in" class="text-blue-600 hover:underline">www.epfindia.gov.in</a></p>
                    </div>
                    <div>
                        <p class="font-semibold mb-1">‚öñÔ∏è Professional Advice:</p>
                        <p>Consult certified financial planners for personalized guidance</p>
                    </div>
                </div>
                <p class="mt-4 text-xs">Last Updated: <span id="footerTimestamp"></span></p>
            </div>
        </footer>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- ENHANCED ACTUARIAL DATA ---
    const IALM_2012_14 = {
        50: 89033, 51: 88478, 52: 87895, 53: 87282, 54: 86638, 55: 85961, 56: 85249, 57: 84499, 58: 83710, 59: 82879,
        60: 82005, 61: 81084, 62: 80114, 63: 79093, 64: 78018, 65: 76887, 66: 75700, 67: 74454, 68: 73148, 69: 71781,
        70: 70351, 71: 68856, 72: 67295, 73: 65668, 74: 63973, 75: 62211, 76: 60381, 77: 58485, 78: 56523, 79: 54497,
        80: 52410, 81: 50264, 82: 48064, 83: 45814, 84: 43519, 85: 41185, 86: 38818, 87: 36425, 88: 34013, 89: 31590,
        90: 29165, 91: 26746, 92: 24342, 93: 21961, 94: 19611, 95: 17300, 96: 15037, 97: 12830, 98: 10688, 99: 8620, 100: 6636
    };
    
    // --- UI ELEMENT REFERENCES ---
    const form = document.getElementById('pensionForm');
    const allInputs = form.querySelectorAll('input, select');
    const taxRatePensionValue = document.getElementById('taxRatePensionValue');
    const taxRateNomineeValue = document.getElementById('taxRateNomineeValue');
    const pastTaxRateValue = document.getElementById('pastTaxRateValue');
    const inflationRateValue = document.getElementById('inflationRateValue');
    const resultsBody = document.getElementById('resultsBody');
    const loader = document.getElementById('loader');
    const errorBanner = document.getElementById('errorBanner');
    const errorText = document.getElementById('errorText');
    
    // Enhanced scenarios with more comprehensive coverage
    const SCENARIOS = [
        { name: '5 Years', termMonths: 5 * 12, icon: 'üéØ' },
        { name: '10 Years', termMonths: 10 * 12, icon: 'üìä' },
        { name: '15 Years', termMonths: 15 * 12, icon: 'üìà' },
        { name: '20 Years', termMonths: 20 * 12, icon: 'üöÄ' },
        { name: '25 Years', termMonths: 25 * 12, icon: 'üíé' },
        { name: '30 Years', termMonths: 30 * 12, icon: 'üèÜ' },
        { name: 'Pensioner\'s Life Expectancy', type: 'pensioner_le', icon: 'üë§' },
        { name: 'Pensioner + Nominee Life Exp.', type: 'pensioner_nominee_le', icon: 'üë•' }
    ];

    let calculationTimeout;
    let irrChart = null;
    let savedScenarioData = null;

    // --- ENHANCED INITIALIZATION ---
    function initialize() {
        populateMonthDropdown();
        updateSliderLabels();
        updateTimestamp();
        setDateLimits();
        initializeChart();
        
        // Add enhanced event listeners
        allInputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(calculationTimeout);
                validateInput(this);
                updateDependentFields();
                calculationTimeout = setTimeout(runCalculations, 500);
            });
            
            input.addEventListener('blur', function() {
                validateInput(this);
            });
        });
        
        // Add form validation
        form.addEventListener('submit', function(e) {
            e.preventDefault();
        });
        
        runCalculations(); // Initial run on page load
    }
    
    function populateMonthDropdown() {
        const monthSelect = document.getElementById('startMonth');
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        months.forEach((month, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = month;
            monthSelect.appendChild(option);
        });
        monthSelect.value = "3"; // Default to April
    }
    
    function setDateLimits() {
        const today = new Date();
        const maxDate = new Date(today.getFullYear() - 18, today.getMonth(), today.getDate());
        const maxDateStr = maxDate.toISOString().split('T')[0];
        
        document.getElementById('pensionerDob').max = maxDateStr;
        document.getElementById('nomineeDob').max = maxDateStr;
        
        // Prevent nominee DOB from being earlier than pensioner DOB
        document.getElementById('pensionerDob').addEventListener('change', function() {
            document.getElementById('nomineeDob').min = this.value;
        });
    }
    
    function updateSliderLabels() {
        const taxRatePension = document.getElementById('taxRatePension');
        const taxRateNominee = document.getElementById('taxRateNominee');
        const pastTaxRate = document.getElementById('pastTaxRate');
        const inflationRate = document.getElementById('inflationRate');
        
        taxRatePensionValue.textContent = parseFloat(taxRatePension.value).toFixed(3);
        taxRateNomineeValue.textContent = parseFloat(taxRateNominee.value).toFixed(3);
        pastTaxRateValue.textContent = parseFloat(pastTaxRate.value).toFixed(3);
        inflationRateValue.textContent = parseFloat(inflationRate.value).toFixed(3);
        
        // Apply surcharge and cess if checkbox is checked
        if (document.getElementById('applySurcharge').checked) {
            applySurchargeAndCess();
        }
    }

    function applySurchargeAndCess() {
        const monthlyPension = parseFloat(document.getElementById('monthlyPension').value) || 0;
        const annualPension = monthlyPension * 12;
        
        let pensionerTaxRate = parseFloat(document.getElementById('taxRatePension').value);
        let nomineeTaxRate = parseFloat(document.getElementById('taxRateNominee').value);
        
        // Apply surcharge based on income brackets
        if (annualPension > 10000000) { // > 1 Cr
            pensionerTaxRate *= 1.19; // 15% surcharge + 4% cess
        } else if (annualPension > 5000000) { // 50L - 1Cr
            pensionerTaxRate *= 1.144; // 10% surcharge + 4% cess
        } else if (annualPension > 1000000) { // > 10L
            pensionerTaxRate *= 1.04; // 4% cess only
        }
        
        // Similar logic for nominee (50% pension)
        const nomineeAnnualPension = (monthlyPension * 0.5) * 12;
        if (nomineeAnnualPension > 10000000) {
            nomineeTaxRate *= 1.19;
        } else if (nomineeAnnualPension > 5000000) {
            nomineeTaxRate *= 1.144;
        } else if (nomineeAnnualPension > 1000000) {
            nomineeTaxRate *= 1.04;
        }
        
        // Update the display values
        taxRatePensionValue.textContent = Math.min(42.744, pensionerTaxRate).toFixed(3);
        taxRateNomineeValue.textContent = Math.min(42.744, nomineeTaxRate).toFixed(3);
    }

    function updateDependentFields() {
        // Update net arrears calculation
        const arrearsReceived = parseFloat(document.getElementById('arrearsReceived').value) || 0;
        const tdsOnArrears = parseFloat(document.getElementById('tdsOnArrears').value) || 0;
        const netArrears = arrearsReceived - tdsOnArrears;
        document.getElementById('netArrears').textContent = formatNumber(netArrears);
        
        // Update post-tax pension calculation
        const monthlyPension = parseFloat(document.getElementById('monthlyPension').value) || 0;
        const taxRate = parseFloat(document.getElementById('taxRatePension').value) / 100;
        const postTaxPension = monthlyPension * (1 - taxRate);
        document.getElementById('postTaxPension').textContent = formatNumber(postTaxPension);
        
        // Update simple payback calculation
        const lumpsumPaid = parseFloat(document.getElementById('lumpsumPaid').value) || 0;
        const netInvestment = lumpsumPaid - netArrears;
        const simplePaybackYears = netInvestment / (postTaxPension * 12);
        document.getElementById('simplePayback').textContent = simplePaybackYears.toFixed(1) + ' yrs';
    }

    function updateTimestamp() {
        const now = new Date();
        const timestamp = now.toLocaleString('en-IN', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        document.getElementById('lastUpdated').textContent = `Last updated: ${timestamp}`;
        document.getElementById('footerTimestamp').textContent = timestamp;
    }

    function initializeChart() {
        const ctx = document.getElementById('irrChart').getContext('2d');
        irrChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Nominal IRR (%)',
                    data: [],
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                }, {
                    label: 'Real IRR (%)',
                    data: [],
                    backgroundColor: 'rgba(16, 185, 129, 0.8)',
                    borderColor: 'rgba(16, 185, 129, 1)',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toFixed(2) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'IRR (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time Horizon'
                        }
                    }
                }
            }
        });
    }

    // --- ENHANCED VALIDATION ---
    function validateInput(input) {
        const value = parseFloat(input.value);
        const errors = [];
        
        // Clear previous error styling
        input.classList.remove('border-red-500', 'error-shake');
        
        switch (input.id) {
            case 'lumpsumPaid':
                if (value <= 0) errors.push('Lump-sum amount must be positive');
                if (value > 100000000) errors.push('Lump-sum amount seems unrealistic (>10 Cr)');
                break;
            case 'arrearsReceived':
                if (value < 0) errors.push('Arrears cannot be negative');
                break;
            case 'tdsOnArrears':
                const arrears = parseFloat(document.getElementById('arrearsReceived').value) || 0;
                if (value < 0) errors.push('TDS cannot be negative');
                if (value > arrears) errors.push('TDS cannot exceed arrears amount');
                if (arrears > 0 && value / arrears > 0.5) errors.push('TDS rate seems unusually high (>50%)');
                break;
            case 'monthlyPension':
                if (value <= 0) errors.push('Monthly pension must be positive');
                if (value > 1000000) errors.push('Monthly pension seems unrealistic (>10L/month)');
                break;
            case 'pensionerDob':
            case 'nomineeDob':
                const dob = new Date(input.value);
                const today = new Date();
                const age = today.getFullYear() - dob.getFullYear();
                if (age < 18) errors.push('Age must be at least 18 years');
                if (age > 100) errors.push('Age seems unrealistic (>100 years)');
                if (input.id === 'nomineeDob') {
                    const pensionerDob = new Date(document.getElementById('pensionerDob').value);
                    if (dob < pensionerDob) {
                        showError('Nominee should typically be younger than or same age as pensioner');
                    }
                }
                break;
        }
        
        if (errors.length > 0) {
            input.classList.add('border-red-500', 'error-shake');
            showError(errors[0]);
        }
        
        return errors.length === 0;
    }

    function showError(message) {
        errorText.textContent = message;
        errorBanner.classList.remove('hidden');
        setTimeout(() => {
            errorBanner.classList.add('hidden');
        }, 7000);
    }

    function hideError() {
        errorBanner.classList.add('hidden');
    }

    // --- MAIN CALCULATION ORCHESTRATOR ---
    async function runCalculations() {
        try {
            loader.classList.remove('hidden');
            resultsBody.classList.add('hidden');
            
            await new Promise(resolve => setTimeout(resolve, 10)); // Allow UI to update
            
            updateSliderLabels();
            updateDependentFields();
            updateTimestamp();
            
            const inputs = getInputs();
            
            // Validate all inputs before proceeding
            if (!validateAllInputs(inputs)) {
                loader.classList.add('hidden');
                return;
            }
            
            const personalData = calculatePersonalData(inputs.pensionerDob, inputs.nomineeDob);
            updateSummaryUI(personalData, inputs);
            
            const results = [];
            for (const scenario of SCENARIOS) {
                const result = calculateScenario(scenario, inputs, personalData);
                results.push(result);
            }
            
            renderResults(results);
            updateChart(results);
            updateInsights(results, inputs);
            updatePerformanceIndicator(results);
            updateScenarioComparison(results, inputs);
            
            loader.classList.add('hidden');
            resultsBody.classList.remove('hidden');
            
        } catch (error) {
            console.error('Calculation error:', error);
            showError('An error occurred during calculations. Please check your inputs and try again.');
            loader.classList.add('hidden');
        }
    }

    function validateAllInputs(inputs) {
        let isValid = true;
        const errors = [];
        
        // Validate numeric inputs
        if (inputs.lumpsumPaid <= 0) {
            errors.push('Lump-sum amount must be positive');
            isValid = false;
        }
        
        if (inputs.monthlyPension <= 0) {
            errors.push('Monthly pension must be positive');
            isValid = false;
        }
        
        if (inputs.tdsOnArrears > inputs.arrearsReceived) {
            errors.push('TDS cannot exceed arrears amount');
            isValid = false;
        }
        
        // Validate dates
        if (!inputs.pensionerDob || !inputs.nomineeDob) {
            errors.push('Both dates of birth must be provided');
            isValid = false;
        }
        
        if (errors.length > 0) {
            showError(errors[0]);
        }
        
        return isValid;
    }

    // --- DATA GATHERING & PREPARATION ---
    function getInputs() {
        const applySurcharge = document.getElementById('applySurcharge').checked;
        let pensionerTaxRate = parseFloat(document.getElementById('taxRatePension').value) / 100;
        let nomineeTaxRate = parseFloat(document.getElementById('taxRateNominee').value) / 100;
        
        // Apply surcharge and cess if enabled
        if (applySurcharge) {
            const monthlyPension = parseFloat(document.getElementById('monthlyPension').value) || 0;
            const annualPension = monthlyPension * 12;
            
            if (annualPension > 10000000) {
                pensionerTaxRate = Math.min(0.42744, pensionerTaxRate * 1.19);
            } else if (annualPension > 5000000) {
                pensionerTaxRate = Math.min(0.42744, pensionerTaxRate * 1.144);
            } else if (annualPension > 1000000) {
                pensionerTaxRate = Math.min(0.42744, pensionerTaxRate * 1.04);
            }
            
            const nomineeAnnualPension = (monthlyPension * 0.5) * 12;
            if (nomineeAnnualPension > 10000000) {
                nomineeTaxRate = Math.min(0.42744, nomineeTaxRate * 1.19);
            } else if (nomineeAnnualPension > 5000000) {
                nomineeTaxRate = Math.min(0.42744, nomineeTaxRate * 1.144);
            } else if (nomineeAnnualPension > 1000000) {
                nomineeTaxRate = Math.min(0.42744, nomineeTaxRate * 1.04);
            }
        }
        
        return {
            lumpsumPaid: parseFloat(document.getElementById('lumpsumPaid').value) || 0,
            arrearsReceived: parseFloat(document.getElementById('arrearsReceived').value) || 0,
            tdsOnArrears: parseFloat(document.getElementById('tdsOnArrears').value) || 0,
            monthlyPension: parseFloat(document.getElementById('monthlyPension').value) || 0,
            startMonth: parseInt(document.getElementById('startMonth').value),
            startYear: parseInt(document.getElementById('startYear').value),
            taxRatePension: pensionerTaxRate,
            taxRateNominee: nomineeTaxRate,
            inflationRate: parseFloat(document.getElementById('inflationRate').value) / 100,
            pensionerDob: document.getElementById('pensionerDob').value,
            nomineeDob: document.getElementById('nomineeDob').value,
            applySurcharge: document.getElementById('applySurcharge').checked
        };
    }

    function calculatePersonalData(pensionerDobStr, nomineeDobStr) {
        const today = new Date();
        const pensionerAge = calculateAge(pensionerDobStr, today);
        const nomineeAge = calculateAge(nomineeDobStr, today);
        
        const pensionerLifeExp = calculateLifeExpectancy(pensionerAge);
        const nomineeLifeExp = calculateLifeExpectancy(nomineeAge);
        
        return {
            pensionerAge,
            nomineeAge,
            pensionerLifeExp,
            nomineeLifeExp
        };
    }

    // --- ENHANCED CORE LOGIC: SCENARIO & CASH FLOW ---
    function calculateScenario(scenario, inputs, personalData) {
        let termInMonths;
        let pensionerTermMonths;
        let nomineeTermMonths = 0;

        if (scenario.type === 'pensioner_le') {
            pensionerTermMonths = Math.round(personalData.pensionerLifeExp * 12);
            termInMonths = pensionerTermMonths;
        } else if (scenario.type === 'pensioner_nominee_le') {
            pensionerTermMonths = Math.round(personalData.pensionerLifeExp * 12);

            // Enhanced: Calculate nominee's age when pensioner's life expectancy ends
            const today = new Date();
            const pensionerEndDate = new Date(today);
            pensionerEndDate.setMonth(pensionerEndDate.getMonth() + pensionerTermMonths);
            
            const nomineeAgeAtPensionerEnd = calculateAge(inputs.nomineeDob, pensionerEndDate);
            const nomineeRemainingLifeExp = calculateLifeExpectancy(nomineeAgeAtPensionerEnd);
            
            nomineeTermMonths = Math.round(nomineeRemainingLifeExp * 12);
            termInMonths = pensionerTermMonths + nomineeTermMonths;
        } else {
            pensionerTermMonths = Math.min(scenario.termMonths, Math.round(personalData.pensionerLifeExp * 12));
            if (scenario.termMonths > pensionerTermMonths) {
                // Calculate nominee portion for fixed-term scenarios
                const today = new Date();
                const pensionerEndDate = new Date(today);
                pensionerEndDate.setMonth(pensionerEndDate.getMonth() + pensionerTermMonths);
                
                const nomineeAgeAtPensionerEnd = calculateAge(inputs.nomineeDob, pensionerEndDate);
                const nomineeRemainingLifeExp = calculateLifeExpectancy(nomineeAgeAtPensionerEnd);
                const maxNomineeTermMonths = Math.round(nomineeRemainingLifeExp * 12);
                
                nomineeTermMonths = Math.min(scenario.termMonths - pensionerTermMonths, maxNomineeTermMonths);
                termInMonths = pensionerTermMonths + nomineeTermMonths;
            } else {
                termInMonths = scenario.termMonths;
            }
        }
        
        const cashflows = generateCashFlows(termInMonths, pensionerTermMonths, inputs);
        
        const nominalIRR = calculateIRR(cashflows.postTax) * 100;
        const realIRR = calculateRealIRR(nominalIRR, inputs.inflationRate * 100);
        const paybackPeriod = calculatePaybackPeriod(cashflows.postTax);
        
        return {
            name: scenario.name,
            icon: scenario.icon || 'üìä',
            termMonths: termInMonths,
            pensionerTermMonths: pensionerTermMonths,
            nomineeTermMonths: nomineeTermMonths,
            nominalIRR: isFinite(nominalIRR) ? nominalIRR : NaN,
            realIRR: isFinite(realIRR) ? realIRR : NaN,
            totalPensionPreTax: cashflows.totalPensionPreTax,
            totalPensionPostTax: cashflows.totalPensionPostTax,
            paybackPeriod: paybackPeriod,
        };
    }

    function generateCashFlows(totalTermMonths, pensionerTermMonths, inputs) {
        const preTaxFlows = [];
        const postTaxFlows = [];
        let totalPensionPreTax = 0;
        let totalPensionPostTax = 0;
        
        // Initial Investment (Outflow)
        const lumpsumDate = new Date('2025-04-01');
        preTaxFlows.push({ date: lumpsumDate, amount: -inputs.lumpsumPaid });
        postTaxFlows.push({ date: lumpsumDate, amount: -inputs.lumpsumPaid });

        // Arrears (Inflow)
        const arrearsDate = new Date('2025-09-15');
        const netArrears = inputs.arrearsReceived - inputs.tdsOnArrears;
        preTaxFlows.push({ date: arrearsDate, amount: inputs.arrearsReceived });
        postTaxFlows.push({ date: arrearsDate, amount: netArrears });
        
        // Pension Inflows
        const pensionStartDate = new Date(inputs.startYear, inputs.startMonth, 1);
        
        const postTaxMonthlyPension = inputs.monthlyPension * (1 - inputs.taxRatePension);
        const nomineePreTaxPension = inputs.monthlyPension * 0.5;
        const nomineePostTaxPension = nomineePreTaxPension * (1 - inputs.taxRateNominee);

        for (let i = 0; i < totalTermMonths; i++) {
            const currentDate = new Date(pensionStartDate);
            currentDate.setMonth(pensionStartDate.getMonth() + i);
            currentDate.setDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate()); // End of month

            if (i < pensionerTermMonths) { // Pensioner receiving pension
                preTaxFlows.push({ date: currentDate, amount: inputs.monthlyPension });
                postTaxFlows.push({ date: currentDate, amount: postTaxMonthlyPension });
                totalPensionPreTax += inputs.monthlyPension;
                totalPensionPostTax += postTaxMonthlyPension;
            } else { // Nominee receiving pension
                preTaxFlows.push({ date: currentDate, amount: nomineePreTaxPension });
                postTaxFlows.push({ date: currentDate, amount: nomineePostTaxPension });
                totalPensionPreTax += nomineePreTaxPension;
                totalPensionPostTax += nomineePostTaxPension;
            }
        }
        
        return {
            preTax: preTaxFlows,
            postTax: postTaxFlows,
            totalPensionPreTax,
            totalPensionPostTax
        };
    }
    
    // --- ENHANCED FINANCIAL CALCULATIONS ---
    function calculateIRR(cashflows, guess = 0.001) {
        if (cashflows.length < 2) return NaN;
        
        // Sort cashflows by date
        const sortedFlows = [...cashflows].sort((a, b) => a.date - b.date);
        
        const MAX_ITERATIONS = 500;
        const PRECISION = 1.0e-12;
        
        let rate = guess;
        
        for (let i = 0; i < MAX_ITERATIONS; i++) {
            let npv = 0;
            let derivative = 0;
            const t0 = sortedFlows[0].date;

            for (const cf of sortedFlows) {
                const daysDiff = (cf.date - t0) / (1000 * 60 * 60 * 24);
                const yearsDiff = daysDiff / 365.25;
                const discountFactor = Math.pow(1 + rate, yearsDiff);
                
                if (discountFactor === 0) return NaN;
                
                npv += cf.amount / discountFactor;
                if (yearsDiff > 0) {
                    derivative -= (yearsDiff * cf.amount) / Math.pow(1 + rate, yearsDiff + 1);
                }
            }
            
            if (Math.abs(npv) < PRECISION) {
                return rate;
            }
            
            if (Math.abs(derivative) < PRECISION) {
                // Try bisection method as fallback
                return bisectionIRR(sortedFlows);
            }
            
            const newRate = rate - npv / derivative;
            
            if (Math.abs(newRate - rate) < PRECISION) {
                return newRate;
            }
            
            // Constrain rate to reasonable bounds
            rate = Math.max(-0.99, Math.min(10, newRate));
        }
        
        // Fallback to bisection method
        return bisectionIRR(sortedFlows);
    }

    function bisectionIRR(cashflows) {
        let low = -0.99;
        let high = 10.0;
        const PRECISION = 1.0e-8;
        const MAX_ITERATIONS = 100;
        
        for (let i = 0; i < MAX_ITERATIONS; i++) {
            const mid = (low + high) / 2;
            const npv = calculateNPV(cashflows, mid);
            
            if (Math.abs(npv) < PRECISION) {
                return mid;
            }
            
            if (npv > 0) {
                low = mid;
            } else {
                high = mid;
            }
            
            if (Math.abs(high - low) < PRECISION) {
                return mid;
            }
        }
        
        return NaN;
    }

    function calculateNPV(cashflows, rate) {
        let npv = 0;
        const t0 = cashflows[0].date;
        
        for (const cf of cashflows) {
            const daysDiff = (cf.date - t0) / (1000 * 60 * 60 * 24);
            const yearsDiff = daysDiff / 365.25;
            npv += cf.amount / Math.pow(1 + rate, yearsDiff);
        }
        
        return npv;
    }

    function calculateRealIRR(nominalIRR, inflationRate) {
        if (isNaN(nominalIRR) || isNaN(inflationRate)) return NaN;
        // Real IRR = (1 + nominal) / (1 + inflation) - 1
        return ((1 + nominalIRR / 100) / (1 + inflationRate / 100) - 1) * 100;
    }

    function calculatePaybackPeriod(cashflows) {
        let cumulativeFlow = 0;
        const sortedFlows = [...cashflows].sort((a, b) => a.date - b.date);
        
        for (let i = 0; i < sortedFlows.length; i++) {
            cumulativeFlow += sortedFlows[i].amount;
            if (cumulativeFlow > 0) {
                const startDate = sortedFlows[0].date;
                const paybackDate = sortedFlows[i].date;
                const days = (paybackDate - startDate) / (1000 * 60 * 60 * 24);
                return days / 365.25; // Return in years
            }
        }
        return null; // Never pays back
    }

    function calculateLifeExpectancy(age) {
        if (!age || age < 50 || age > 100) return 0;
        const intAge = Math.floor(age);
        
        const lx = IALM_2012_14[intAge] || IALM_2012_14[100];
        if (!lx) return 0;
        
        let sum_lx_plus_t = 0;
        for (let t = intAge + 1; t <= 100; t++) {
            sum_lx_plus_t += IALM_2012_14[t] || 0;
        }
        
        const curtateExpectation = sum_lx_plus_t / lx;
        return curtateExpectation + 0.5; // Add 0.5 for a more accurate estimate
    }
    
    // --- ENHANCED UI RENDERING & HELPERS ---
    function updateSummaryUI(data, inputs) {
        document.getElementById('pensionerAge').textContent = data.pensionerAge.toFixed(1) || '-';
        document.getElementById('pensionerLifeExp').textContent = data.pensionerLifeExp.toFixed(1) + ' yrs' || '-';
        document.getElementById('nomineeAge').textContent = data.nomineeAge.toFixed(1) || '-';
        document.getElementById('nomineeLifeExp').textContent = data.nomineeLifeExp.toFixed(1) + ' yrs' || '-';
        
        // Update additional metrics
        const netInvestment = inputs.lumpsumPaid - (inputs.arrearsReceived - inputs.tdsOnArrears);
        const monthlyPostTax = inputs.monthlyPension * (1 - inputs.taxRatePension);
        const annualPension = inputs.monthlyPension * 12;
        const simplePaybackYears = netInvestment / (monthlyPostTax * 12);
        
        document.getElementById('netInvestment').textContent = formatCurrency(netInvestment);
        document.getElementById('monthlyPostTax').textContent = formatCurrency(monthlyPostTax);
        document.getElementById('annualPension').textContent = formatCurrency(annualPension);
        document.getElementById('simplePayback').textContent = simplePaybackYears.toFixed(1) + ' yrs';
    }
    
    function renderResults(results) {
        resultsBody.innerHTML = '';
        results.forEach((res, index) => {
            const row = document.createElement('tr');
            const isLifeExpectancy = res.name.includes("Life");
            
            row.className = `hover:bg-gray-50 transition-colors ${
                isLifeExpectancy ? "bg-blue-50 border-l-4 border-blue-400 font-semibold" : ""
            }`;
            
            const formatIRR = (irr) => {
                if (isNaN(irr)) return '<span class="text-gray-400">N/A</span>';
                const color = irr > 12 ? 'text-green-600 font-bold' : 
                             irr > 8 ? 'text-blue-600 font-semibold' : 
                             irr > 5 ? 'text-yellow-600' : 
                             irr > 0 ? 'text-orange-600' : 'text-red-600';
                return `<span class="${color}">${irr.toFixed(2)}%</span>`;
            };
            
            const formatPayback = (years) => {
                if (!years) return '<span class="text-gray-400">Never</span>';
                if (years < 1) return `<span class="text-green-600 font-semibold">${Math.round(years * 12)} months</span>`;
                if (years < 5) return `<span class="text-blue-600 font-semibold">${years.toFixed(1)} years</span>`;
                if (years < 10) return `<span class="text-yellow-600">${years.toFixed(1)} years</span>`;
                return `<span class="text-orange-600">${years.toFixed(1)} years</span>`;
            };
            
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex items-center">
                        <span class="text-lg mr-2">${res.icon}</span>
                        <div>
                            <div class="text-sm font-medium text-gray-900">${res.name}</div>
                            <div class="text-xs text-gray-500">${res.termMonths} months total</div>
                        </div>
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-center">${formatIRR(res.nominalIRR)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">${formatIRR(res.realIRR)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm text-gray-900">${formatCurrency(res.totalPensionPostTax)}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center">${formatPayback(res.paybackPeriod)}</td>
            `;
            resultsBody.appendChild(row);
        });
    }

    function updateChart(results) {
        if (!irrChart) return;
        
        const validResults = results.filter(r => !isNaN(r.nominalIRR) && !isNaN(r.realIRR));
        
        irrChart.data.labels = validResults.map(r => r.name.replace(' Life Exp.', '').replace('Pensioner + Nominee', 'P+N'));
        irrChart.data.datasets[0].data = validResults.map(r => r.nominalIRR);
        irrChart.data.datasets[1].data = validResults.map(r => r.realIRR);
        
        // Update colors based on performance
        irrChart.data.datasets[0].backgroundColor = validResults.map(r => {
            if (r.nominalIRR > 12) return 'rgba(34, 197, 94, 0.8)';
            if (r.nominalIRR > 8) return 'rgba(59, 130, 246, 0.8)';
            if (r.nominalIRR > 5) return 'rgba(251, 191, 36, 0.8)';
            return 'rgba(239, 68, 68, 0.8)';
        });
        
        irrChart.data.datasets[1].backgroundColor = validResults.map(r => {
            if (r.realIRR > 8) return 'rgba(16, 185, 129, 0.8)';
            if (r.realIRR > 5) return 'rgba(34, 197, 94, 0.8)';
            if (r.realIRR > 2) return 'rgba(251, 191, 36, 0.8)';
            return 'rgba(239, 68, 68, 0.8)';
        });
        
        irrChart.update();
    }

    function updateInsights(results, inputs) {
        const insights = [];
        const validResults = results.filter(r => !isNaN(r.nominalIRR));
        
        if (validResults.length === 0) {
            insights.push(`‚ö†Ô∏è <strong>No Valid Results:</strong> Please check your inputs - the calculations may not converge with current values.`);
        } else {
            const bestNominal = validResults.reduce((best, current) => 
                current.nominalIRR > (best.nominalIRR || -Infinity) ? current : best, {});
            const bestReal = validResults.reduce((best, current) => 
                current.realIRR > (best.realIRR || -Infinity) ? current : best, {});
            
            const lifeExpectancyResult = results.find(r => r.name.includes("Pensioner's Life"));
            const combinedLifeResult = results.find(r => r.name.includes("Pensioner + Nominee"));
            
            // Performance insights
            if (bestNominal.nominalIRR > 15) {
                insights.push(`üéâ <strong>Excellent Returns:</strong> Best nominal IRR is ${bestNominal.nominalIRR.toFixed(2)}% (${bestNominal.name}). This significantly outperforms most safe investments.`);
            } else if (bestNominal.nominalIRR > 10) {
                insights.push(`üëç <strong>Strong Returns:</strong> Best nominal IRR is ${bestNominal.nominalIRR.toFixed(2)}% (${bestNominal.name}). This compares favorably with equity market returns.`);
            } else if (bestNominal.nominalIRR > 7) {
                insights.push(`üìà <strong>Good Returns:</strong> Best nominal IRR is ${bestNominal.nominalIRR.toFixed(2)}% (${bestNominal.name}). This beats most fixed deposits.`);
            } else {
                insights.push(`‚ö†Ô∏è <strong>Moderate Returns:</strong> Best nominal IRR is ${bestNominal.nominalIRR.toFixed(2)}% (${bestNominal.name}). Consider if this meets your expectations.`);
            }
            
            // Real returns insight
            if (bestReal.realIRR > 5) {
                insights.push(`üí™ <strong>Inflation-Beating Returns:</strong> Best real IRR is ${bestReal.realIRR.toFixed(2)}%, preserving and growing your purchasing power.`);
            } else if (bestReal.realIRR > 2) {
                insights.push(`üìä <strong>Inflation Protection:</strong> Real IRR of ${bestReal.realIRR.toFixed(2)}% provides modest protection against inflation.`);
            } else if (bestReal.realIRR > 0) {
                insights.push(`‚ö° <strong>Limited Real Growth:</strong> Real IRR of ${bestReal.realIRR.toFixed(2)}% barely keeps pace with inflation.`);
            } else {
                insights.push(`üîª <strong>Inflation Risk:</strong> Negative real IRR of ${bestReal.realIRR.toFixed(2)}% means purchasing power may decline.`);
            }
            
            // Life expectancy insights
            if (lifeExpectancyResult && !isNaN(lifeExpectancyResult.nominalIRR)) {
                const lifeYears = Math.round(lifeExpectancyResult.termMonths / 12);
                insights.push(`üë§ <strong>Life Expectancy Scenario (${lifeYears} years):</strong> ${lifeExpectancyResult.nominalIRR.toFixed(2)}% nominal / ${lifeExpectancyResult.realIRR.toFixed(2)}% real returns.`);
            }
            
            if (combinedLifeResult && !isNaN(combinedLifeResult.nominalIRR)) {
                const totalYears = Math.round(combinedLifeResult.termMonths / 12);
                const nomineeYears = Math.round(combinedLifeResult.nomineeTermMonths / 12);
                insights.push(`üë• <strong>Combined Life Scenario (${totalYears} years total, ${nomineeYears} nominee years):</strong> ${combinedLifeResult.nominalIRR.toFixed(2)}% nominal returns.`);
            }
            
            // Payback insights
            const fastestPayback = validResults
                .filter(r => r.paybackPeriod && r.paybackPeriod < 20)
                .reduce((min, current) => 
                    !min || current.paybackPeriod < min.paybackPeriod ? current : min, null);
                    
            if (fastestPayback) {
                if (fastestPayback.paybackPeriod < 5) {
                    insights.push(`‚ö° <strong>Quick Recovery:</strong> Investment recovers in just ${fastestPayback.paybackPeriod.toFixed(1)} years (${fastestPayback.name}).`);
                } else if (fastestPayback.paybackPeriod < 10) {
                    insights.push(`üîÑ <strong>Reasonable Payback:</strong> Investment recovers in ${fastestPayback.paybackPeriod.toFixed(1)} years (${fastestPayback.name}).`);
                } else {
                    insights.push(`‚è≥ <strong>Long Payback:</strong> Investment takes ${fastestPayback.paybackPeriod.toFixed(1)} years to recover (${fastestPayback.name}).`);
                }
            }
            
            // Tax efficiency insight
            const netInvestment = inputs.lumpsumPaid - (inputs.arrearsReceived - inputs.tdsOnArrears);
            const monthlyPostTax = inputs.monthlyPension * (1 - inputs.taxRatePension);
            const taxImpact = inputs.taxRatePension * 100;
            
            if (taxImpact > 35) {
                insights.push(`üí∞ <strong>High Tax Impact:</strong> ${taxImpact.toFixed(1)}% tax rate significantly affects returns. Consider tax-efficient strategies.`);
            } else if (taxImpact > 25) {
                insights.push(`üìä <strong>Moderate Tax Impact:</strong> ${taxImpact.toFixed(1)}% tax rate moderately impacts your pension income.`);
            }
            
            // Risk assessment
            insights.push(`üõ°Ô∏è <strong>Risk Profile:</strong> EPS pension is government-backed, making it lower risk than market investments but with limited upside potential.`);
            
            // Comparative insight
            const fdRate = 7.5; // Typical FD rate
            if (bestNominal.nominalIRR > fdRate + 2) {
                insights.push(`üèÜ <strong>Beats Fixed Deposits:</strong> Returns significantly exceed typical FD rates (${fdRate}%).`);
            } else if (bestNominal.nominalIRR > fdRate) {
                insights.push(`üìà <strong>Competitive Returns:</strong> Returns marginally beat typical FD rates (${fdRate}%).`);
            } else {
                insights.push(`‚ö†Ô∏è <strong>Below FD Returns:</strong> Returns are lower than typical FD rates (${fdRate}%). Consider your options carefully.`);
            }
        }
        
        document.getElementById('insights').innerHTML = insights.join('<br><br>');
    }

    function updatePerformanceIndicator(results) {
        const validResults = results.filter(r => !isNaN(r.nominalIRR));
        if (validResults.length === 0) return;
        
        const avgNominalIRR = validResults.reduce((sum, r) => sum + r.nominalIRR, 0) / validResults.length;
        const avgRealIRR = validResults.reduce((sum, r) => sum + (r.realIRR || 0), 0) / validResults.length;
        
        const indicator = document.getElementById('performanceIndicator');
        const icon = document.getElementById('performanceIcon');
        const title = document.getElementById('performanceTitle');
        const desc = document.getElementById('performanceDesc');
        
        indicator.classList.remove('hidden', 'border-green-500', 'border-blue-500', 'border-yellow-500', 'border-red-500', 
                                  'bg-green-50', 'bg-blue-50', 'bg-yellow-50', 'bg-red-50');
        
        if (avgRealIRR > 5) {
            indicator.classList.add('border-green-500', 'bg-green-50');
            icon.innerHTML = `<div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-lg">A+</div>`;
            title.textContent = 'Excellent Investment Performance';
            title.className = 'font-semibold text-green-800';
            desc.textContent = `Outstanding real returns of ${avgRealIRR.toFixed(1)}% significantly beat inflation and provide strong wealth growth.`;
            desc.className = 'text-sm text-green-700';
        } else if (avgRealIRR > 2) {
            indicator.classList.add('border-blue-500', 'bg-blue-50');
            icon.innerHTML = `<div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold text-lg">A</div>`;
            title.textContent = 'Strong Investment Performance';
            title.className = 'font-semibold text-blue-800';
            desc.textContent = `Solid real returns of ${avgRealIRR.toFixed(1)}% beat inflation and provide meaningful wealth growth.`;
            desc.className = 'text-sm text-blue-700';
        } else if (avgRealIRR > 0) {
            indicator.classList.add('border-yellow-500', 'bg-yellow-50');
            icon.innerHTML = `<div class="w-10 h-10 bg-yellow-500 rounded-full flex items-center justify-center text-white font-bold text-lg">B</div>`;
            title.textContent = 'Moderate Investment Performance';
            title.className = 'font-semibold text-yellow-800';
            desc.textContent = `Real returns of ${avgRealIRR.toFixed(1)}% provide basic inflation protection but limited real growth.`;
            desc.className = 'text-sm text-yellow-700';
        } else {
            indicator.classList.add('border-red-500', 'bg-red-50');
            icon.innerHTML = `<div class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white font-bold text-lg">C</div>`;
            title.textContent = 'Below Average Performance';
            title.className = 'font-semibold text-red-800';
            desc.textContent = `Real returns of ${avgRealIRR.toFixed(1)}% may not keep pace with inflation. Consider reviewing your strategy.`;
            desc.className = 'text-sm text-red-700';
        }
        
        indicator.classList.remove('hidden');
    }

    function updateScenarioComparison(results, inputs) {
        if (!savedScenarioData) return;
        
        const comparisonSection = document.getElementById('scenarioComparison');
        const currentContent = document.getElementById('currentScenarioContent');
        
        const currentSummary = {
            monthlyPension: inputs.monthlyPension,
            taxRate: (inputs.taxRatePension * 100).toFixed(1),
            lumpsumPaid: inputs.lumpsumPaid,
            bestIRR: results.reduce((best, current) => 
                (!isNaN(current.nominalIRR) && current.nominalIRR > (best.nominalIRR || -Infinity)) ? current : best, {})
        };
        
        const changeIndicator = (current, saved, unit = '') => {
            const diff = current - saved;
            if (Math.abs(diff) < 0.01) return `${current}${unit}`;
            const color = diff > 0 ? 'text-green-600' : 'text-red-600';
            const arrow = diff > 0 ? '‚Üë' : '‚Üì';
            return `${current}${unit} <span class="${color}">(${arrow}${Math.abs(diff).toFixed(1)}${unit})</span>`;
        };
        
        currentContent.innerHTML = `
            <p class="text-xs mb-1">Monthly Pension: ‚Çπ${changeIndicator(currentSummary.monthlyPension, savedScenarioData.monthlyPension)}</p>
            <p class="text-xs mb-1">Tax Rate: ${changeIndicator(parseFloat(currentSummary.taxRate), parseFloat(savedScenarioData.taxRate), '%')}</p>
            <p class="text-xs mb-1">Lump-sum: ‚Çπ${changeIndicator(currentSummary.lumpsumPaid, savedScenarioData.lumpsumPaid)}</p>
            <p class="text-xs">Best IRR: ${currentSummary.bestIRR.nominalIRR ? currentSummary.bestIRR.nominalIRR.toFixed(2) + '%' : 'N/A'}</p>
        `;
        
        comparisonSection.style.display = 'block';
    }

    function calculateAge(dob, fromDate = new Date()) {
        const birthDate = new Date(dob);
        if (isNaN(birthDate)) return 0;
        
        const diffTime = fromDate - birthDate;
        const diffYears = diffTime / (1000 * 60 * 60 * 24 * 365.25);
        
        return Math.max(0, diffYears);
    }

    function formatCurrency(value) {
        if (Math.abs(value) >= 10000000) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value / 10000000) + ' Cr';
        } else if (Math.abs(value) >= 100000) {
            return new Intl.NumberFormat('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            }).format(value / 100000) + ' L';
        }
        return new Intl.NumberFormat('en-IN', {
            style: 'currency',
            currency: 'INR',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }
    
    function formatNumber(value) {
        return new Intl.NumberFormat('en-IN').format(value);
    }

    // --- ENHANCED UTILITY FUNCTIONS ---
    window.resetToDefaults = function() {
        document.getElementById('lumpsumPaid').value = '5000000';
        document.getElementById('arrearsReceived').value = '1500000';
        document.getElementById('tdsOnArrears').value = '150000';
        document.getElementById('monthlyPension').value = '50000';
        document.getElementById('startMonth').value = '3';
        document.getElementById('startYear').value = '2025';
        document.getElementById('taxRatePension').value = '30';
        document.getElementById('taxRateNominee').value = '20';
        document.getElementById('inflationRate').value = '6';
        document.getElementById('pensionerDob').value = '1965-04-01';
        document.getElementById('nomineeDob').value = '1968-04-01';
        document.getElementById('pastPension').value = '2000000';
        document.getElementById('pastTaxRate').value = '20';
        document.getElementById('applySurcharge').checked = false;
        
        savedScenarioData = null;
        document.getElementById('scenarioComparison').style.display = 'none';
        
        runCalculations();
    };

    window.saveScenario = function() {
        const inputs = getInputs();
        const personalData = calculatePersonalData(inputs.pensionerDob, inputs.nomineeDob);
        
        savedScenarioData = {
            monthlyPension: inputs.monthlyPension,
            taxRate: (inputs.taxRatePension * 100).toFixed(1),
            lumpsumPaid: inputs.lumpsumPaid,
            pensionerAge: personalData.pensionerAge.toFixed(1),
            nomineAge: personalData.nomineeAge.toFixed(1),
            timestamp: new Date().toLocaleString()
        };
        
        const savedContent = document.getElementById('savedScenarioContent');
        savedContent.innerHTML = `
            <p class="text-xs mb-1">Monthly Pension: ‚Çπ${formatNumber(savedScenarioData.monthlyPension)}</p>
            <p class="text-xs mb-1">Tax Rate: ${savedScenarioData.taxRate}%</p>
            <p class="text-xs mb-1">Lump-sum: ‚Çπ${formatNumber(savedScenarioData.lumpsumPaid)}</p>
            <p class="text-xs mb-1">Ages: ${savedScenarioData.pensionerAge} / ${savedScenarioData.nomineAge}</p>
            <p class="text-xs text-gray-400">Saved: ${savedScenarioData.timestamp}</p>
        `;
        
        document.getElementById('savedScenario').classList.add('saved');
        document.getElementById('scenarioComparison').style.display = 'block';
        
        // Show success message briefly
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'Saved!';
        button.classList.add('bg-green-100', 'text-green-700');
        setTimeout(() => {
            button.textContent = originalText;
            button.classList.remove('bg-green-100', 'text-green-700');
        }, 2000);
    };

    window.toggleAssumptions = function() {
        const content = document.getElementById('assumptionsContent');
        const arrow = document.getElementById('assumptionsArrow');
        
        content.classList.toggle('expanded');
        arrow.classList.toggle('rotate-180');
    };

    window.exportResults = function() {
        try {
            const inputs = getInputs();
            const personalData = calculatePersonalData(inputs.pensionerDob, inputs.nomineeDob);
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "EPS 95 Higher Pension Scheme ROI Analysis Report\n";
            csvContent += `Generated on: ${new Date().toLocaleString('en-IN')}\n`;
            csvContent += `Calculator Version: Production v2.0\n\n`;
            
            // Input Summary
            csvContent += "=== INPUT SUMMARY ===\n";
            csvContent += `Lump-sum Paid to EPFO,‚Çπ${inputs.lumpsumPaid}\n`;
            csvContent += `Arrears Received,‚Çπ${inputs.arrearsReceived}\n`;
            csvContent += `TDS on Arrears,‚Çπ${inputs.tdsOnArrears}\n`;
            csvContent += `Net Arrears,‚Çπ${inputs.arrearsReceived - inputs.tdsOnArrears}\n`;
            csvContent += `Monthly Pension (Pre-Tax),‚Çπ${inputs.monthlyPension}\n`;
            csvContent += `Pensioner Tax Rate,${(inputs.taxRatePension * 100).toFixed(2)}%\n`;
            csvContent += `Nominee Tax Rate,${(inputs.taxRateNominee * 100).toFixed(2)}%\n`;
            csvContent += `Expected Inflation Rate,${(inputs.inflationRate * 100).toFixed(1)}%\n`;
            csvContent += `Surcharge & Cess Applied,${inputs.applySurcharge ? 'Yes' : 'No'}\n`;
            csvContent += `Pensioner Age,${personalData.pensionerAge.toFixed(1)} years\n`;
            csvContent += `Pensioner Life Expectancy,${personalData.pensionerLifeExp.toFixed(1)} years\n`;
            csvContent += `Nominee Age,${personalData.nomineeAge.toFixed(1)} years\n`;
            csvContent += `Nominee Life Expectancy,${personalData.nomineeLifeExp.toFixed(1)} years\n\n`;
            
            // Calculated Metrics
            const netInvestment = inputs.lumpsumPaid - (inputs.arrearsReceived - inputs.tdsOnArrears);
            const monthlyPostTax = inputs.monthlyPension * (1 - inputs.taxRatePension);
            csvContent += "=== CALCULATED METRICS ===\n";
            csvContent += `Net Investment,‚Çπ${netInvestment}\n`;
            csvContent += `Monthly Post-Tax Pension,‚Çπ${monthlyPostTax.toFixed(0)}\n`;
            csvContent += `Annual Pre-Tax Pension,‚Çπ${inputs.monthlyPension * 12}\n`;
            csvContent += `Simple Payback Period,${(netInvestment / (monthlyPostTax * 12)).toFixed(1)} years\n\n`;
            
            // Results
            csvContent += "=== SCENARIO ANALYSIS ===\n";
            csvContent += "Scenario,Term (Months),Pensioner Term,Nominee Term,Nominal IRR (%),Real IRR (%),Total Pension (Post-Tax),Payback Period (Years)\n";
            
            // Calculate scenarios for export
            const results = [];
            for (const scenario of SCENARIOS) {
                const result = calculateScenario(scenario, inputs, personalData);
                results.push(result);
                csvContent += `"${result.name}",${result.termMonths},${result.pensionerTermMonths},${result.nomineeTermMonths || 0},${result.nominalIRR.toFixed(3)},${result.realIRR.toFixed(3)},‚Çπ${result.totalPensionPostTax.toFixed(0)},${result.paybackPeriod ? result.paybackPeriod.toFixed(2) : 'N/A'}\n`;
            }
            
            csvContent += "\n=== ASSUMPTIONS ===\n";
            csvContent += "Mortality Table,Indian Assured Lives Mortality (IALM 2012-14)\n";
            csvContent += "Pension Payment,End of each month\n";
            csvContent += "Nominee Pension,50% of pensioner amount\n";
            csvContent += "Tax Rates,Assumed constant throughout horizon\n";
            csvContent += "IRR Method,Newton-Raphson with bisection fallback\n";
            csvContent += "Date Calculations,Exact day calculations using 365.25 day years\n";
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `EPS95_ROI_Analysis_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (error) {
            console.error('Export error:', error);
            showError('Failed to export data. Please try again or contact support.');
        }
    };

    window.printResults = function() {
        window.print();
    };

    // --- START THE APPLICATION ---
    initialize();
});
</script>

<!-- Print Styles -->
<style media="print">
    .no-print { display: none !important; }
    body { font-size: 12px; }
    .container { max-width: none; margin: 0; padding: 10px; }
    .lg\\:col-span-1, .lg\\:col-span-2 { width: 100%; }
    .grid { display: block; }
    .shadow-xl, .shadow-lg { box-shadow: none; }
    .bg-gradient-to-br, .bg-gradient-to-r { background: white !important; }
</style>
</body>
</html>